<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>kube-up.sh kubernetes多节点部署方式分析 | 个人学习记录</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.101.0" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

<link href="https://alfredhuang211.github.io/css/kityminder.core.css" rel="stylesheet">
<link href="https://alfredhuang211.github.io/css/mindmap.css" rel="stylesheet">

<script src="https://alfredhuang211.github.io/js/kity.min.js"></script>
<script src="https://alfredhuang211.github.io/js/kityminder.core.min.js"></script>
<script src="https://alfredhuang211.github.io/js/jquery.slim.min.js"></script>
<script src="https://alfredhuang211.github.io/js/mindmap.js"></script>

    
    
      

    

    
    
    <meta property="og:title" content="kube-up.sh kubernetes多节点部署方式分析" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://alfredhuang211.github.io/k8s/kube-up.sh-kubernetes%E5%A4%9A%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F%E5%88%86%E6%9E%90/" /><meta property="article:section" content="k8s" />
<meta property="article:published_time" content="2022-06-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-06-27T00:00:00+00:00" />

<meta itemprop="name" content="kube-up.sh kubernetes多节点部署方式分析">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2022-06-27T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-06-27T00:00:00+00:00" />
<meta itemprop="wordCount" content="112">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="kube-up.sh kubernetes多节点部署方式分析"/>
<meta name="twitter:description" content=""/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        个人学习记录
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/" title="Home page">
              Home
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/docs" title="文档应用 page">
              文档应用
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/web3" title="Web 3.0 page">
              Web 3.0
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/k8s" title="Kubernetes page">
              Kubernetes
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/serverless" title="Serverless page">
              Serverless
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about" title="About page">
              About
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">kube-up.sh kubernetes多节点部署方式分析</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2022-06-27T00:00:00Z">June 27, 2022</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-solid serif f4 nested-links mid-gray pr4-l w-100-l"><h1 id="kube-upsh-kubernetes多节点部署方式分析">kube-up.sh kubernetes多节点部署方式分析</h1>
<p>标签： kube-up kubernetes k8s 部署</p>
<hr>
<p>kubernetes 项目内带有的 kube-up, 可以很方便的完成 kubernetes 的部署操作. 在此, 以 ubuntu 部署为例,进行一下 kube-up 流程的分析.</p>
<p>在kube-up.sh调用前,主要的环境变量设置需求是</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export nodes<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;root@192.168.4.218 root@192.168.4.217&#34;</span>
</span></span><span style="display:flex;"><span>export role<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ai i&#34;</span>
</span></span><span style="display:flex;"><span>export NUM_NODES<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NUM_NODES<span style="color:#66d9ef">:-</span>2<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>在此处确定了集群主机,执行相关命令的用户,主机的角色,集群规模,在后续的部署中,会根据此定义,对主机进行相应的部署操作.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export KUBERNETES_PROVIDER<span style="color:#f92672">=</span>ubuntu
</span></span></code></pre></div><p>在此处确定了使用何种 PROVIDER. 此处由于进行的是针对 ubuntu 主机的集群组建,因此设置为 ubuntu. 本身 kube-up 支持多种 PROVIDER 的集群配置,例如 aws, gce, azure, openstack, centos 等等. 各 PROVIDER 的具体入口都在相应目录下 util.sh 中的 kube-up 函数.</p>
<p>由于此部署全部通过 ssh, scp 等完成针对主机的文件拷贝和命令执行, 因此, 在执行 kube.sh 的主机上,需要完成 ssk key 的配置, 从此执行主机上可以无密码 ssh 登录到任一集群主机.</p>
<p>在 kube-up.sh 脚本开始, 通过引入 kube-util.sh, 根据 KUBERNETES_PROVIDER 的值, 引入相应文件夹下的 util.sh.此处引入的是ubuntu下的util.sh.</p>
<p>调用verify-prereqs, 由于上一步做了引入, 实际执行的是 ubuntu/util.sh内的verify-prereqs.在其中检查了ssh-agent相关配置,需要至少引入一组密钥.</p>
<p>执行kube-up函数,实际调用的是ubuntu/util.sh内的kube-up函数.</p>
<p>在kube-up内,首先会去下载组件,准备相应的二进制文件,配置文件等.根据ETCD_VERSION,FLANNEL_VERSION,KUBE_VERSION,分别去github各项目下载对应的release包,将其中的二进制文件,分别放置在master文件夹和minion文件夹内,分别为master节点和worker节点准备.</p>
<p>接着,根据配置的nodes和对应的role,对每台主机依次执行相应操作.</p>
<pre><code>role设置为a的主机,执行provision-master.主要操作是将相关文件拷贝到主机上,包括二进制文件,系统启动脚本和配置文件,配置脚本等.通过ssh,在主机上执行命令,完成组件启动配置文件的生成.同时,在master节点上,需要通过make-ca-cert.sh脚本,生成若干cert和key文件,用于运行时的认证服务.另外,会根据网络的使用情况,进行docker的配置和服务重启.

role设置为i的主机,执行provision-node.主要操作类似,将相关文件拷贝到主机上,包括二进制文件,服务启动脚本和配置文件,配置脚本蹬.通过ssh,在主机上执行相关命令,完成组件启动配置文件的生成.启动服务.一样会根据网络配置,修改docker的配置,重启docker daemon.

role为ai的主机,同时执行了a和i相关的操作.
</code></pre>
<p>各节点部署完毕后,会执行verify-cluster,同样会使用nodes和role,根据各个role,在节点上去分别检查master和worker部署情况.其中检查都是通过检验相应需要的daemon是否在运行,判断部署是否正确.</p>
<p>完成检查后,通过引入common.sh,调用load-or-gen-kube-basicauth,完成k8s环境的相应认证的配置和生成.</p>
<p>通过执行create-kubeconfig,在~/.kube/config内生成当前集群的配置信息.包括集群api-server入口位置,相应context,用户相关等.</p>
<p>至此, kube-up 函数调用完成,后续调用回到kube-up.sh内.</p>
<p>执行validate-cluster. 默认调用validata-cluster.sh, 通过kubectl get nodes, 确定节点启动和准备好的数量符合需求,通过 kubectl get componentstatuses ,确 master 各组件健康状态正常.</p>
<p>最终通过 kubectl cluster-info 输出集群信息,完成部署.</p>
<p><img src="kube-up.png" alt=""></p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://alfredhuang211.github.io/" >
    &copy;  个人学习记录 2022 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
