<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>docker跨主机overlay网络配置 | 个人学习记录</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.101.0" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

<link href="https://alfredhuang211.github.io/css/kityminder.core.css" rel="stylesheet">
<link href="https://alfredhuang211.github.io/css/mindmap.css" rel="stylesheet">

<script src="https://alfredhuang211.github.io/js/kity.min.js"></script>
<script src="https://alfredhuang211.github.io/js/kityminder.core.min.js"></script>
<script src="https://alfredhuang211.github.io/js/jquery.slim.min.js"></script>
<script src="https://alfredhuang211.github.io/js/mindmap.js"></script>

    
    
      

    

    
    
    <meta property="og:title" content="docker跨主机overlay网络配置" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://alfredhuang211.github.io/k8s/docker%E8%B7%A8%E4%B8%BB%E6%9C%BAoverlay%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/" /><meta property="article:section" content="k8s" />
<meta property="article:published_time" content="2022-06-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-06-27T00:00:00+00:00" />

<meta itemprop="name" content="docker跨主机overlay网络配置">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2022-06-27T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-06-27T00:00:00+00:00" />
<meta itemprop="wordCount" content="324">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="docker跨主机overlay网络配置"/>
<meta name="twitter:description" content=""/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        个人学习记录
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/" title="Home page">
              Home
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/docs" title="文档应用 page">
              文档应用
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/web3" title="Web 3.0 page">
              Web 3.0
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/k8s" title="Kubernetes page">
              Kubernetes
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/serverless" title="Serverless page">
              Serverless
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about" title="About page">
              About
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">docker跨主机overlay网络配置</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2022-06-27T00:00:00Z">June 27, 2022</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-solid serif f4 nested-links mid-gray pr4-l w-100-l"><h1 id="docker跨主机overlay网络配置">docker跨主机overlay网络配置</h1>
<h2 id="环境说明">环境说明:</h2>
<p>ubuntu14.04.4</p>
<p>4.2.0 kernel</p>
<p>docker 1.10.3</p>
<p>etcd 2.3.6</p>
<h2 id="etcd配置">etcd配置:</h2>
<h3 id="etcd启动">etcd启动</h3>
<p>etcd启动命令:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcd --advertise-client-urls <span style="color:#e6db74">&#39;http://192.168.15.232:2379&#39;</span> --listen-client-urls <span style="color:#e6db74">&#39;http://0.0.0.0:2379&#39;</span>
</span></span></code></pre></div><p>需要确保 advertise-client-urls 是在正确的ip和端口上监听</p>
<h3 id="etcd检查">etcd检查</h3>
<ul>
<li>本机检查:</li>
</ul>
<p>在etcd运行的机器上,检查启动情况:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl member list
</span></span><span style="display:flex;"><span>ce2a822cea30bfca: name<span style="color:#f92672">=</span>default peerURLs<span style="color:#f92672">=</span>http://localhost:2380,http://localhost:7001 clientURLs<span style="color:#f92672">=</span>http://192.168.15.232:2379 isLeader<span style="color:#f92672">=</span>true
</span></span></code></pre></div><p>检查功能是否正确,能否正确设置和获取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl mk key value
</span></span><span style="display:flex;"><span>etcdctl get key 
</span></span><span style="display:flex;"><span>value
</span></span></code></pre></div><ul>
<li>远程检查</li>
</ul>
<p>在其他主机上,验证远程连接的正确性,是否可以正确设置和获取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcdctl -endpoints http://192.168.15.232:2379 get key
</span></span><span style="display:flex;"><span>value
</span></span><span style="display:flex;"><span>/etcdctl -endpoints http://192.168.15.232:2379 mk key2 value2
</span></span><span style="display:flex;"><span>value2
</span></span><span style="display:flex;"><span>./etcdctl -endpoints http://192.168.15.232:2379 get key2 
</span></span><span style="display:flex;"><span>value2
</span></span></code></pre></div><h2 id="docker配置">docker配置</h2>
<p>在/etc/docker下新建或修改文件daemon.json,添加内容:</p>
<p>一台主机</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;cluster-store&#34;</span>:<span style="color:#e6db74">&#34;etcd://192.168.15.232:2379&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;cluster-advertise&#34;</span>:<span style="color:#e6db74">&#34;192.168.15.232:2376&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>另外一台主机</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;cluster-store&#34;</span>:<span style="color:#e6db74">&#34;etcd://192.168.15.232:2379&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;cluster-advertise&#34;</span>:<span style="color:#e6db74">&#34;192.168.15.233:2376&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其中cluster-store指向etcd所在设备ip,cluster-advertise内填写本机ip地址</p>
<h3 id="配置生效">配置生效</h3>
<p>如果是1.10.3版本的docker,需要重启docker服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>service docker restart
</span></span></code></pre></div><p>如果是1.11版本的docker,可以通过发送信号reload配置文件,ps查看到docker daemon的pid:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kill -s SIGHUP <span style="color:#ae81ff">8182</span>
</span></span></code></pre></div><h3 id="生效检查">生效检查</h3>
<p>执行命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker info
</span></span></code></pre></div><p>其中信息有:</p>
<pre tabindex="0"><code>Cluster store: etcd://192.168.15.232:2379
Cluster advertise: 192.168.15.233:2376
</code></pre><p>说明集群信息正确配置进入了docker deamon</p>
<p>另外:</p>
<pre tabindex="0"><code>Plugins: 
 Volume: local
 Network: overlay bridge null host
</code></pre><p>此处也说明了支持创建的网络类型.其中overlay就是用来建立跨主机网络的类型.</p>
<h2 id="docker网络创建">docker网络创建</h2>
<p>执行命令:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker network create -d overlay t1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker network ls
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NETWORK ID          NAME                DRIVER
</span></span><span style="display:flex;"><span>f5ec4b3e24d8        t1                  overlay             
</span></span><span style="display:flex;"><span>9a1aa00e5873        docker_gwbridge     bridge              
</span></span><span style="display:flex;"><span>b71af588fbe1        none                null                
</span></span><span style="display:flex;"><span>61fab2c54528        host                host                
</span></span><span style="display:flex;"><span>507e83023697        bridge              bridge    
</span></span></code></pre></div><p>可以看到网络已建立.
可以在创建是使用 &lsquo;&ndash;subnet=192.168.1.0/24&rsquo; 这种类型来规定创建子网的网段.</p>
<h3 id="确认创建">确认创建</h3>
<p>在其他主机上执行 &lsquo;docker network ls&rsquo;,应该均能看到已创建的t1网络的信息.</p>
<h2 id="容器加入">容器加入</h2>
<h3 id="创建时加入">创建时加入</h3>
<p>在执行 &lsquo;docker run&rsquo; 时使用参数 &lsquo;&ndash;net t1&rsquo;, 使得创建的容器能加入t1网络:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -id --net t1 --name t233_t1 busybox sh
</span></span></code></pre></div><h3 id="创建后加入">创建后加入</h3>
<p>已经在运行的容器也可以加入网络,通过执行命令:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -id --name t233_t1 busybox sh
</span></span><span style="display:flex;"><span>docker network connect t1 t233_out
</span></span></code></pre></div><h2 id="网络互通">网络互通</h2>
<p>在不同主机上创建或加入容器到网络内,并在容器内互相 ping .在这种情况下,可以通过直接 ping 容器名的方式确认网络连接已通.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec t233_t1 ping t232_t1
</span></span></code></pre></div><h2 id="其他">其他</h2>
<ul>
<li>在使用overlay网络的情况下,容器默认带有的bridge网络还是存在,可以在容器内看到两个网口.这种时候容器访问外网通过的是bridge网络.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec 233_t1 ip addr
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">65536</span> qdisc noqueue 
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>    inet6 ::1/128 scope host 
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>79: eth0@if80: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span style="color:#ae81ff">1450</span> qdisc noqueue 
</span></span><span style="display:flex;"><span>    link/ether 02:42:0a:00:00:02 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    inet 10.0.0.2/24 scope global eth0
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>    inet6 fe80::42:aff:fe00:2/64 scope link 
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>81: eth1@if82: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue 
</span></span><span style="display:flex;"><span>    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    inet 172.18.0.2/16 scope global eth1
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>    inet6 fe80::42:acff:fe12:2/64 scope link 
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>docker exec 233_t1 ping www.baidu.com
</span></span><span style="display:flex;"><span>PING www.baidu.com <span style="color:#f92672">(</span>112.80.248.73<span style="color:#f92672">)</span>: <span style="color:#ae81ff">56</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 112.80.248.73: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">54</span> time<span style="color:#f92672">=</span>39.120 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 112.80.248.73: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">54</span> time<span style="color:#f92672">=</span>40.778 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 112.80.248.73: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">54</span> time<span style="color:#f92672">=</span>39.840 ms
</span></span></code></pre></div><ul>
<li>容器可以加入多个overlay网络.但是在docker run的时候,只能通过 &ndash;net 指定一个网络,要加入其他网络需要在启动后通过 docker network connect 来添加</li>
</ul>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://alfredhuang211.github.io/" >
    &copy;  个人学习记录 2022 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
